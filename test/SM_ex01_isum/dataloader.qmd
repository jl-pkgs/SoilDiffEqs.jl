```{julia}
using SoilDifferentialEquations, OrdinaryDiffEq
using Plots, Test, RTableTools, Dates
import HydroTools: sceua, GOF, of_KGE, of_NSE
import NetCDFTools: approx
import Ipaper: set_seed
using Optim

includet("main_Tsoil.jl")

# 定义土壤属性
nlayer = 66
Δz = fill(0.02, nlayer)
z = [4, 12, 14, 16, 20, 24, 28, 32, 36, 42, 50, 52] * 25.4 / 1000 # inch -> mm -> m
inds_obs = round.(Int, z / 0.02) # 取这些层的数据
```

## 加载数据

```{julia}
d = fread("$dir_soil/data/isusm_TS_202207.csv")
t = d.time
yobs = Matrix(d[:, 4:end]) # 共有12层土壤数据

set_seed(1)
TS0 = yobs[:, 1] # 从第10层开始
Tsoil0 = approx(inds_obs, yobs[1, :], 1:nlayer) + randn(nlayer) * 0.5

function dataloader_soil()
  soil = init_soil(Δz; soil_type = 7)
  soil.Tsoil .= Tsoil0
  soil
end

```

## 优化模型参数

```{julia}
function model_sim(theta; ibeg::Int=5)
  soil = dataloader_soil()
  κ, cv = theta2param(theta)
  soil.κ .= κ
  soil.cv .= cv
  ysim = solve_Tsoil_ODE(soil, TS0; ibeg)
  ysim
end

function goal(theta; ibeg::Int=5)
  ysim = model_sim(theta; ibeg)
  obs = yobs[:, 2:end][:]
  sim = ysim[:, 2:end][:]
  # of_MSE(obs, sim)
  gof = GOF(obs, sim)
  @show gof.NSE
  -gof.NSE
end

soil = dataloader_soil()
theta = param2theta(soil)
# @time model_sim(theta)

ibeg = 5
ysim = solve_Tsoil_bonan(soil, TS0; ibeg)
```




```{julia}
soil = dataloader_soil()

x0 = [soil.κ; soil.cv]
lower = [fill(0.1, nlayer); fill(1.0, nlayer) * 1e6]
upper = [fill(10.0, nlayer); fill(5.0, nlayer) * 1e6]

f(theta) = goal(theta; ibeg)
# inner_optimizer = GradientDescent()
# options = Optim.Options(show_trace=true)
# r = optimize(f, lower, upper, x0, Fminbox(inner_optimizer), options)
@time theta, feval, exitflag = sceua(f, x0, lower, upper; maxn=Int(1e2))
```


## 绘图

```{julia}
plot(
  [plot_soil(i) for i in 1:12]...,
  size=(1200, 800),
)
```
