#import "@local/modern-cug-report:0.1.3": *
#show: doc => template(doc, footer: "CUG水文气象学2025", header: "")

// #show heading.where(level: 1): set text(weight: "regular")

= 1 最大下渗能力

#beamer-block[最终采用的方案（2025-11-05）。]

全部采用Richards方程，优点是不同降水场次之间的土壤水分再分布问题自然解决，无需额外假设。具体做法如下：

假设地表达到饱和，坐标系向下为负。

$
  Delta H_0 = H_0 - H_1 = (h_0 + 0) - (-(Delta z_1)/2 + psi_1) 
$

其中，$H$表示每层土壤具有的总水头（总水势），$h_0$代表积水深度，$psi_1$代表地表土壤的基质势。从地表到第一层土壤，$Delta z_0 = z_0 - z_1 = (Delta z_1) / 2 $。

$
  f_"potential" = - K_1 (Delta H_0) / (Delta z_0) = -K_1 (h_0 - psi_1 + (Delta z_1)/2) / ((Delta z_1)/2) \

  = - K_1 [ 2(h_0 - psi_1) / (Delta z_1) + 1 ]
$

其中，需要主意$f_"potential"$的负号表示方向，向下下渗为负。


= 2 地表积水

== 2.1 当前方案

```julia
# Ponded water after runoff. This one is related to runoff. LHe.
soil.z_water = (soil.z_water + (P - inf) * kstep) * r_drainage
```

r_drainage表示地表排水系数，取值范围0-1，1表示没有排水，0表示完全排水。

*问题分析*：

1. *物理机制不明确*：r_drainage是经验系数，缺乏明确物理意义
2. *忽略重要因素*：未考虑地形坡度、地表糙度、积水深度对径流的影响
3. *时间尺度问题*：每个时间步都乘以r_drainage，相当于指数衰减，物理解释不清
4. *与1.1节脱节*：1.1中$h_0$已经影响下渗能力，但地表水量平衡逻辑不够清晰。


== 2.2 改进方案

=== 2.2.1 方案A：基于蓄水容量的方案（推荐用于平坦地区）

```julia
# 参数
h_pond_max = 0.5  # 最大地表蓄水深度 [cm]，代表微地形蓄水能力

# 地表水量平衡
h_pond = soil.z_water + (P - inf) * kstep  # [cm]

# 产流计算
if h_pond > h_pond_max
    runoff = h_pond - h_pond_max
    soil.z_water = h_pond_max
else
    runoff = 0.0
    soil.z_water = h_pond
end
```

*优点*：
- 物理意义明确：h_pond_max代表微地形蓄水容量
- 与1.1节耦合：h_0 = soil.z_water直接影响下渗能力
- 符合蓄满产流机制

*适用场景*：平坦地区、农田、城市下垫面


=== 2.2.2 方案B：基于坡面汇流的方案（推荐用于坡地）

*理论基础：曼宁公式*

曼宁公式（Manning's equation）是描述明渠均匀流的经典公式：

$
  v = 1/n R^(2/3) S_0^(1/2)
$

其中：
- $v$：平均流速 [m/s]
- $n$：曼宁粗糙系数 [s/m^(1/3)]
- $R$：水力半径 [m]，定义为 $R = A / P$
  - $A$：过流断面积 [m²]
  - $P$：湿周 [m]
- $S_0$：水力坡度（对于均匀流等于底坡） [-]

*地表薄层流简化*：

假设地表为宽浅矩形断面，单位宽度：
- 断面积：$A = h dot.c b$ [m²/m]
- 湿周：$P approx 2h + b$ [m/m]（忽略侧壁，因为 $h << b$）
- 水力半径：$R = A/P = (h b) / (2h + b) approx h$ [m]

因此曼宁公式简化为：

$
  v = 1/n h^(2/3) S_0^(1/2)
$

*单位宽度流量*：

$
  q = v dot.c h = 1/n h^(5/3) S_0^(1/2)
$

单位：
- $v$ [m/s]
- $h$ [m]
- $q$ [m²/s]（单位宽度流量）

*排水速率*：

考虑一个矩形网格单元：
- 长度（汇流方向）：$L$ [m]
- 宽度（垂直汇流方向）：$B$ [m]
- 网格面积：$A_"grid" = L dot.c B$ [m²]
- 积水深度：$h$ [m]
- 积水体积：$V = h dot.c A_"grid"$ [m³]

*出流流量*：

在下边界（出流断面），宽度为 $B$，单位宽度流量为 $q$：

$
  Q_"out" = q dot.c B = 1/n h^(5/3) S_0^(1/2) dot.c B quad [m³ \/s]
$

*积水深度变化率*：

由于径流导致的积水深度减小速率：

$
  (partial h)/(partial t) = - Q_"out" / A_"grid" = - (q dot.c B)/(L dot.c B) = - q/L
$

因此：

$
  "drain_rate" = q/L = 1/(n L) h^(5/3) S_0^(1/2) quad [m\/s]
$

*为什么是 q/L？*

从*连续性方程*（质量守恒）出发：

$
  (partial h)/(partial t) + (partial q)/(partial x) = r
$

其中：
- $h$：水深 [m]
- $q$：单位宽度流量 [m²/s]
- $x$：沿坡面方向坐标 [m]
- $r$：源汇项（降雨-下渗）[m/s]

*只考虑径流排水*（$r=0$）：

$
  (partial h)/(partial t) = - (partial q)/(partial x)
$

*$pdv(q, x)$ 的物理意义*：
- 流量沿程变化率
- $(partial q)/(partial x) > 0$：流量沿程增大 → 水在汇聚 → $h$ 增加
- $(partial q)/(partial x) < 0$：流量沿程减小 → 水在流失 → $h$ 减小

*简化为 q/L*：

考虑长度为 $L$ 的坡面单元：
- *上边界*（坡顶，$x=0$）：流量 $q_0 approx 0$（假设无来水）
- *下边界*（坡底，$x=L$）：流量 $q_L = q$（由曼宁公式计算）

流量沿程变化的平均值：

$
  (partial q)/(partial x) approx (Delta q)/(Delta x) = (q_L - q_0)/L = q/L
$

因此：

$
  (partial h)/(partial t) = - q/L
$

*物理解释*：
- $q$ 越大：出流越多 → 消退越快
- $L$ 越大：相同出流下，分摊到单位面积的损失越小 → 消退越慢
- $L$ 越小：相同出流下，单位面积损失越大 → 消退越快

*示例*：
- 出流：$q = 0.001$ m²/s
- 长坡面（$L=100$ m）：$(partial h)/(partial t) = -0.00001$ m/s = -0.036 cm/h
- 短坡面（$L=10$ m）：$(partial h)/(partial t) = -0.0001$ m/s = -0.36 cm/h（快10倍）

*注意*：这是*简化假设*，完整的运动波方程需要考虑 $h$ 沿程变化和曼宁公式的非线性，但对于网格尺度的均匀坡面，$q/L$ 近似是合理的。

单位转换：[m/s] → [cm/h]，乘以 $3600 times 100 = 360000$

#v(1em)

==== 2.2.2.1 *典型排水速率参考值*

使用曼宁公式 $"drain_rate" = 1/(n L) h^(5/3) S_0^(1/2)$ 计算典型情况：

#figure(
  table(
    columns: 6,
    align: (center, center, center, center, center, center),
    [*下垫面*], [*n*], [*S₀*], [*L (m)*], [*h (cm)*], [*drain_rate (cm/h)*],

    // 平坦农田
    [平坦农田], [0.15], [0.001], [50], [0.5], [0.17],
    [], [], [], [], [1.0], [0.76],
    [], [], [], [], [2.0], [2.42],

    // 坡地农田
    [坡地农田], [0.15], [0.05], [50], [0.5], [1.21],
    [], [], [], [], [1.0], [5.39],
    [], [], [], [], [2.0], [17.1],

    // 草地
    [草地], [0.25], [0.02], [100], [0.5], [0.24],
    [], [], [], [], [1.0], [1.08],
    [], [], [], [], [2.0], [3.42],

    // 森林/灌木
    [森林/灌木], [0.40], [0.10], [100], [1.0], [2.70],
    [], [], [], [], [2.0], [8.57],
    [], [], [], [], [5.0], [34.0],

    // 裸地/光滑面
    [裸地], [0.03], [0.02], [30], [0.2], [1.89],
    [], [], [], [], [0.5], [8.45],
    [], [], [], [], [1.0], [37.7],

    // 城市不透水面
    [不透水面], [0.015], [0.01], [50], [0.2], [0.72],
    [], [], [], [], [0.5], [3.22],
    [], [], [], [], [1.0], [14.4],
  ),
  caption: [不同下垫面条件下的典型排水速率]
)

*关键观察*：

1. *坡度影响*：$S_0$ 从 0.001 → 0.05（50倍），排水速率增加约 $sqrt(50) approx 7$ 倍

2. *积水深度影响*：$h$ 从 0.5 → 2.0 cm（4倍），排水速率增加 $4^(5/3) approx 10$ 倍（非线性！）

3. *糙度影响*：光滑表面（n=0.015）比森林（n=0.40）排水快约 27 倍

4. *坡长影响*：$L$ 从 30 → 100 m，排水速率减少约 3.3 倍（反比关系）

5. *典型量级*：
   - 平坦地区：0.1 - 5 cm/h
   - 坡地：1 - 20 cm/h
   - 极端情况（大积水深度+陡坡+光滑面）：可达 50+ cm/h

*与降雨强度对比*：
- 小雨：< 2.5 mm/h (0.25 cm/h)
- 中雨：2.5 - 8 mm/h (0.25 - 0.8 cm/h)
- 大雨：8 - 16 mm/h (0.8 - 1.6 cm/h)
- 暴雨：16 - 32 mm/h (1.6 - 3.2 cm/h)
- 大暴雨：> 32 mm/h (> 3.2 cm/h)

*实际意义*：
- 平坦农田在小-中雨时，排水速率可能低于降雨强度 → 易积水
- 坡地在中-大雨时，排水速率可能超过降雨强度 → 快速产流
- 积水深度对排水速率影响巨大（$h^(5/3)$ 关系）


==== 2.2.2.2 *单站点模拟中 L 的取值*

单站点模拟不同于分布式网格模拟，$L$ 的物理意义需要重新理解。以下是几种取值方法：

*方法1：基于观测点代表性尺度*（推荐）

气象/水文观测站点通常代表周围一定范围的平均状况：
- *标准气象站*：代表性半径约 10-50 km（但地表径流尺度远小于此）
- *地表过程尺度*：考虑地表径流的实际作用范围，取 $L = 10-100$ m 较合理
- *推荐值*：
  - 农田/草地观测点：$L = 30-50$ m
  - 森林观测点：$L = 50-100$ m
  - 城市观测点：$L = 10-30$ m

*方法2：等效网格尺度*

如果单站点模拟将来要应用到区域模型：
- 将单站点视为未来网格化模型的一个网格单元
- $L$ 取目标网格分辨率：
  - 高分辨率（1-5 km）：$L = 100-500$ m
  - 中分辨率（10-25 km）：$L = 1000-2500$ m
  - 粗分辨率（50+ km）：$L = 5000+$ m

*注意*：$L$ 越大，排水越慢，地表积水调蓄能力越强。

*方法3：基于实际坡长*

如果站点位于已知坡面上：
- *丘陵地*：典型坡长 50-200 m
- *山区*：典型坡长 100-500 m
- *平原*：取分水岭到汇流点距离，通常 50-500 m

可通过 DEM 分析获得实际坡长。

*方法4：敏感性分析与率定*

将 $L$ 作为可调参数，通过观测数据率定：

1. *参考观测量*：
   - 径流量/径流系数
   - 产流历时
   - 峰值流量时间

2. *率定范围*：$L = 10-200$ m（单站点典型范围）

3. *敏感性分析*：
   - $L$ 小（10-30 m）：排水快，峰值流量高，历时短
   - $L$ 大（100-200 m）：排水慢，峰值流量低，历时长

*方法5：转换为等效蓄水容量*（推荐用于单站点）

如果觉得 $L$ 的不确定性太大，可以转换为*等效最大蓄水深度*：

对于特定的 $h$ 值，令排水速率等于某个特征值：

$
  "drain_rate"_"char" = q/L = 1/(n L) h_"char"^(5/3) S_0^(1/2)
$

定义等效蓄水容量：

$
  h_"pond,eff" = integral_0^infinity "drain_rate"(t) d t approx (h_"char" dot.c tau)
$

其中 $tau = L / v_"char"$ 是特征排水时间常数。

*更简单的做法*：直接使用*方案A（蓄水容量方案）*，避免引入不确定的 $L$ 参数：

```julia
# 对于单站点，直接指定蓄水容量更直观
h_pond_max = 0.5  # [cm]，可通过观测率定
```

*推荐策略*：

1. *如果有明确坡度信息*：使用方案B/C，取 $L = 30-100$ m
2. *如果坡度不明确或接近平坦*：使用方案A，直接指定 $h_"pond,max"$
3. *如果有径流观测数据*：率定 $L$ 或 $h_"pond,max"$
4. *快速测试*：先用 $L = 50$ m，然后做敏感性分析

*参数不确定性的影响*：

假设 $h = 1$ cm, $n = 0.15$, $S_0 = 0.02$：

#figure(
  table(
    columns: 3,
    align: (center, center, center),
    [*L (m)*], [*drain_rate (cm/h)*], [*特征排水时间 (h)*],
    [10], [10.8], [0.09],
    [30], [3.6], [0.28],
    [50], [2.2], [0.46],
    [100], [1.1], [0.92],
    [200], [0.54], [1.85],
  ),
  caption: [L 参数对排水过程的影响]
)

特征排水时间估算为 $tau approx h / "drain_rate"$。

*实现代码*：

```julia
# 参数
S0 = 0.05          # 地面坡度 [-]
n_manning = 0.15   # 曼宁粗糙系数 [s/m^(1/3)]
h_pond_min = 0.1   # 起始产流深度 [cm]

# 地表水量平衡
h_pond = soil.z_water + (P - inf) * kstep  # [cm]

# 产流计算（简化运动波）
if h_pond > h_pond_min
    # 曼宁公式：v = (1/n) * R^(2/3) * S^(1/2)
    # 假设宽浅水流：R ≈ h
    h_m = (h_pond - h_pond_min) / 100  # 转换为 [m]
    v = (1/n_manning) * (h_m^(2/3)) * sqrt(S0)  # [m/s]

    # 单位宽度流量 q = v * h
    q = v * h_m * 3600  # [m²/h] → [cm²/h]

    # 特征汇流长度（网格尺度或坡长）
    L_char = 100  # [m]，需根据实际网格确定

    # 排水速率
    drain_rate = q / L_char * 100  # [cm/h]

    # 更新积水深度
    drainage = min(drain_rate * kstep, h_pond - h_pond_min)
    runoff = drainage
    soil.z_water = h_pond - drainage
else
    runoff = 0.0
    soil.z_water = max(h_pond, 0.0)
end
```

*优点*：
- 考虑地形坡度和地表糙度
- 积水深度越大，排水越快（非线性关系）
- 物理过程清晰

*适用场景*：坡地、山区、自然流域

*参数参考值*：
- 裸地/光滑表面：n = 0.01-0.05
- 农田：n = 0.10-0.20
- 草地：n = 0.15-0.40
- 森林/灌木：n = 0.30-0.80


#pagebreak()

=== 2.2.3 方案C：混合方案（推荐）

```julia
# 参数
h_pond_min = 0.1   # 微地形蓄水容量 [cm]
h_pond_max = 2.0   # 最大允许积水深度 [cm]
S0 = 0.01          # 坡度 [-]
n_manning = 0.15   # 曼宁系数
L_char = 100       # 汇流特征长度 [m]

# 地表水量平衡
h_pond = soil.z_water + (P - inf) * kstep

# 分段处理
if h_pond <= h_pond_min
    # 微地形蓄水阶段：无径流
    runoff = 0.0
    soil.z_water = max(h_pond, 0.0)

elseif h_pond <= h_pond_max
    # 坡面汇流阶段：运动波方程
    h_excess = h_pond - h_pond_min
    h_m = h_excess / 100
    v = (1/n_manning) * (h_m^(2/3)) * sqrt(max(S0, 1e-6))
    q = v * h_m * 3600 * 100  # [cm²/h]
    drain_rate = q / L_char  # [cm/h]

    drainage = min(drain_rate * kstep, h_excess)
    runoff = drainage
    soil.z_water = h_pond - drainage

else
    # 超蓄阶段：立即产流
    runoff = h_pond - h_pond_max
    soil.z_water = h_pond_max
end
```

*优点*：
- 综合考虑微地形蓄水和坡面汇流
- 三阶段机制符合实际观测
- 参数物理意义明确，可通过观测率定

*物理解释*：
1. *h < h_pond_min*：降水填充微地形，无径流
2. *h_pond_min < h < h_pond_max*：坡面漫流，径流速率随积水深度增加
3. *h > h_pond_max*：超过地表调蓄能力，快速产流


= 3 与Richards方程的耦合

无论采用哪种方案，地表积水深度 $h_0$ (即 `soil.z_water`) 都会影响1.1节中的最大下渗能力：

$
  f_"potential" = - K_1 [ 2(h_0 - psi_1) / (Delta z_1) + 1 ]
$

*耦合机制*：
- $h_0$ 越大 → 水头梯度越大 → 下渗能力越强
- 下渗量越大 → 积水消耗越快 → $h_0$ 减小
- 形成负反馈调节


= 4 建议

1. *通用场景*：推荐*方案C（混合方案）*，物理完整且参数可率定
2. *计算效率优先*：推荐*方案A（蓄水容量）*，计算简单
3. *坡地模拟*：必须使用*方案B或C*，考虑地形影响
4. *参数获取*：
   - h_pond_min：田间观测或经验值（0.1-0.5 cm）
   - n_manning：查表或实验测定
   - S0：DEM提取或实测
   - L_char：网格分辨率或坡长
